name: üì¶ Deploy Hugo Site

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

defaults:
  run:
    shell: bash

env:
  HUGO_GOCACHE: /tmp/hugo_cache_runner
  NODE_VERSION: 24.x
  HUGO_VERSION: 0.149.0

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: ‚öôÔ∏è Checkout Repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # Build Site
      - name: ‚öôÔ∏è Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: üì¶ Cache Hugo Modules
        uses: actions/cache@v4
        with:
          path: ${{ env.HUGO_GOCACHE }}
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugomod-

      - name: üî® Build Hugo Production Site
        run: npm run build:prod

      # Publish
      - name: ‚è´ Upload artifact
        uses: actions/upload-pages-artifact@v4
        id: upload
        with:
          path: ./public

      - name: ‚è∫ Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: üîî Ntfy Deployment Success
        if: steps.deploy.outcome == 'success'
        shell: pwsh
        env:
          NTFY_URLTOPIC: ${{ secrets.NTFY_URLTOPIC }}
          NTFY_USER: ${{ secrets.NTFY_USER }}
          NTFY_PW: ${{ secrets.NTFY_PW }}
        run: |
          # Send notification to ntfy instance
          $Credential = [PSCredential]::new($env:NTFY_USER, (ConvertTo-SecureString -String '$env:NTFY_PW' -AsPlainText -Force))
          $NtfyHeaders = @{
              Actions = "view, Open GitHub, https://github.com/hudsonm62/hudsonmcnamara.com; view, See Website, https://hudsonmcnamara.com"
              Title = "Website Deployment Successful!"
              Tags = "hammer"
              Icon = "https://hudsonmcnamara.com/img/author.png"
          }
          $Request = @{
              Method = "POST"
              URI = "$env:NTFY_URLTOPIC"
              Authentication = "Basic"
              Credential = $Credential
              Headers = $NtfyHeaders
              Body = "hudsonmcnamara.com has been successfully deployed via GitHub Actions."
          }

          Invoke-RestMethod @Request
